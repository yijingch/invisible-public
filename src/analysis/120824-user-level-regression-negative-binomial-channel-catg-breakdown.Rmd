---
title: "Zero-inflated regression (user-level)"
author: "yijing"
date: "2024-07-09"
output: html_document
---

OLS Regression: fits line to minimize the squared residuals in the y direction (residuals should be normally distributed around fitted line  with consistant variance)

Generalized linear model (for counts): allow the DV to distribute differently
- Poisson
- Negative Binomial

Resources:

1. https://cran.r-project.org/web/packages/svyVGAM/vignettes/zeroinfl.html

"if you didn’t see any salmon it could be because the area is salmon-free or because you just randomly didn’t see any. To turn this into a regression model we typically put a logistic regression structure on Z and a Poisson regression structure on P"

2. https://strengejacke.github.io/sjstats/reference/svyglm.zip.html

3. https://notstatschat.rbind.io/2015/05/26/zero-inflated-poisson-from-complex-samples/
- dataset used in this example: https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/DEMO_C.htm 
- packages used in this example: https://www.rdocumentation.org/packages/survey/versions/4.4-2/topics/svydesign


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(svyVGAM)
library(survey)
library(pscl)
library(ggplot2)
library(MASS)
library(performance)
library(tidyverse)
library(AER)
```

```{r}
ROOTPATH <- substr(getwd(), 1, nchar(getwd())-12)
ROOTPATH
```

# Load data

```{r}
reg_table <- read.csv(paste(ROOTPATH, "output/reg_table_filter_ytb_activities_channel_catg_counts_122324.csv", sep=""))
reg_table$age = reg_table$age / 10
reg_table$timespan_imputed = reg_table$timespan_imputed / 60
#reg_table$extreme_lftRght = abs(reg_table$lftRght - 3)
#reg_table$extreme_antiPro = abs(reg_table$feel_thm_fdsz - 5)
#reg_table$extreme_lftRght[is.na(reg_table$extreme_lftRght)] <- 0
#reg_table$extreme_antiPro[is.na(reg_table$extreme_antiPro)] <- 0
reg_table
```


# Negative Bionomial regression (NBR)

## glmmTMB

### anti-/pro-gov

```{r}
library(glmmTMB)

nbr.view <- glmmTMB(
  #view_anti ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #view_netr ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #view_pro ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  weights = weight,
  data = subset(reg_table, if_view==1), 
  family = nbinom2)

nbr.subscribe <- glmmTMB(
  #subscribe_anti ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #subscribe_netr ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #subscribe_pro ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  weights = weight,
  data = subset(reg_table, if_subscribe==1), 
  family = nbinom2)

nbr.comment <- glmmTMB(
  #comment_anti ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #comment_netr ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  #comment_pro ~ gender + age + education + timespan_imputed + interest_politics + if_progov + if_antigov,
  weights = weight,
  data = subset(reg_table, if_comment==1), 
  family = nbinom2)

```

### left/right

```{r}
library(glmmTMB)

nbr.view <- glmmTMB(
  #view_anti ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  #view_netr ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  view_pro ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  weights = weight,
  data = subset(reg_table, if_view==1), 
  family = nbinom2)

nbr.subscribe <- glmmTMB(
  #subscribe_anti ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  #subscribe_netr ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  subscribe_pro ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  weights = weight,
  data = subset(reg_table, if_subscribe==1), 
  family = nbinom2)

nbr.comment <- glmmTMB(
  #comment_anti ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  #comment_netr ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  comment_pro ~ gender + age + education + timespan_imputed + interest_politics + if_left + if_right,
  weights = weight,
  data = subset(reg_table, if_comment==1), 
  family = nbinom2)

```

```{r}
#summary(nbr.view)
#summary(nbr.subscribe)
#summary(nbr.comment)
```

# Visualizations 

## dotwhisker
```{r}
library(dotwhisker)
models <- list(comment=nbr.comment, subscribe=nbr.subscribe, view=nbr.view)
reg_plot = dwplot(models, 
                  dot_args=list(size=5), 
                  whisker_args=list(size=1.5)) +
    facet_grid(~model, scales="free_x") +
    theme_bw(base_size = 10) +
    geom_vline(xintercept = 0, colour = "black", linetype = 2, size=1) + 
    scale_color_manual(values=c("#4582b4", "#ff4500","#2d8b57")) + 
    theme(legend.position="none") + 
    #ggtitle("(A) Anti-government channels") +
    #ggtitle("(B) Neutral channels") +
    ggtitle("(C) Pro-government channels") +
    theme(
      plot.title = element_text(face = "bold", size=24),
      text = element_text(size = 22),
      axis.text.x = element_text(size=15)) + 
    scale_y_discrete(labels = c("right", "left", "interest in politics", "timespan", "education", "age","gender"))
    #scale_y_discrete(labels = c("anti-gov", "pro-gov", "interest in politics", "timespan", "education", "age","gender"))
  
ggsave(
  paste(ROOTPATH, "output/results-summary-122724/nbr_coeff_nbinom2_progov_channels_lftrght.pdf", sep=""), 
  device="pdf",
  width=10,
  plot=reg_plot)
reg_plot
```


## GGally
 
```{r}
library(GGally)
ggcoef_model(nbr.view) + 
  labs(x = "coefficients")

ggcoef_model(nbr.subscribe) + 
  labs(x = "coefficients")

ggcoef_model(nbr.comment) + 
  labs(x = "coefficients")
```

```{r}
check_zeroinflation(nbr.view)
check_zeroinflation(nbr.subscribe)
check_zeroinflation(nbr.comment)
```
# Now, apply zero-inflated models

```{r}
des = svydesign(
  id = ~0, # specifying cluster ids from largest level to smallest level (0 or 1 is for no clusters)
  weights = ~weight,
  data = reg_table)
```


```{r}
#reg_table_filter <- na.omit(reg_table)
reg_table_filter <- reg_table

zinb.view <- zeroinfl(
  view_counts ~ gender + age + education + interest_politics + if_progov + if_antigov, 
  data = reg_table_filter, 
  weights = weight,
  link = "logit", 
  dist = "negbin")

zinb.subscribe <- zeroinfl(
  subscribe_counts ~ gender + age + education + interest_politics + if_progov + if_antigov, 
  data = reg_table_filter, 
  weights = weight,
  link = "logit", 
  dist = "negbin")

zinb.comment <- zeroinfl(
  comment_counts ~ gender + age + education + interest_politics + if_progov + if_antigov, 
  data = reg_table_filter, 
  weights = weight,
  link = "logit", 
  dist = "negbin")

# summary(zinb)
```

```{r}
BIC(zinb.view)
BIC(zinb.subscribe)
BIC(zinb.comment)
```
















