---
title: "Zero-inflated regression (user-level)"
author: "yijing"
date: "2024-07-09"
output: html_document
---

OLS Regression: fits line to minimize the squared residuals in the y direction (residuals should be normally distributed around fitted line  with consistant variance)

Generalized linear model (for counts): allow the DV to distribute differently
- Poisson
- Negative Binomial

Resources:

1. https://cran.r-project.org/web/packages/svyVGAM/vignettes/zeroinfl.html

"if you didn’t see any salmon it could be because the area is salmon-free or because you just randomly didn’t see any. To turn this into a regression model we typically put a logistic regression structure on Z and a Poisson regression structure on P"

2. https://strengejacke.github.io/sjstats/reference/svyglm.zip.html

3. https://notstatschat.rbind.io/2015/05/26/zero-inflated-poisson-from-complex-samples/
- dataset used in this example: https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/DEMO_C.htm 
- packages used in this example: https://www.rdocumentation.org/packages/survey/versions/4.4-2/topics/svydesign


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(svyVGAM)
library(survey)
library(pscl)
library(ggplot2)
library(MASS)
library(performance)
library(tidyverse)
library(AER)
```

```{r}
ROOTPATH <- substr(getwd(), 1, nchar(getwd())-12)
ROOTPATH
```

# Load data

```{r}
reg_table <- read.csv(paste(ROOTPATH, "output/reg_table_nofilter.csv", sep=""))
reg_table
```

# Quick exploration

```{r}
summary(reg_table$view_counts)
var(reg_table$view_counts) # over-dispersion may be a problem here?
summary(reg_table$subscribe_counts)
var(reg_table$subscribe_counts)
summary(reg_table$comment_counts)
var(reg_table$comment_counts)
```


```{r}
# look at the distributions: view, subscribe and comment

ggplot(reg_table, aes(x=view_counts)) + 
  geom_histogram(color="white", fill="#E9C46A", bins=40) 

ggplot(reg_table, aes(x=subscribe_counts)) + 
  geom_histogram(color="white", fill="#F4A261", bins=40)

ggplot(reg_table, aes(x=comment_counts)) + 
  geom_histogram(color="white", fill="#E76F51", bins=40)
```
# Check Regression model first

## Poisson regression 
(in the case with over dispersion it's very ubiquitous, we're using NB instead)

```{r}
reg_table_filter <- na.omit(reg_table)
# reg_table_filter <- filter(reg_table_filter, view_counts > 0)  # if only select non-zero DVs
model.prm <- glm(view_counts ~ gender + age + education + interest_politics + 
             if_left + if_center + if_right + 
             if_progov + if_neutral + if_antigov, 
           weights = weight,
           data = reg_table_filter,
           family = "poisson")
print(dispersiontest(model.prm)) # we have significant over-dispersion, we should not be using a prm
summary(model.prm)
```


```{r}
library(GGally)
ggcoef_model(model.prm) + 
  labs(x = "view_counts")
```

## Negative Bionomial regression

explicitly models over-dispersion
```{r}
reg_table_filter <- na.omit(reg_table)
# reg_table_filter <- filter(reg_table_filter, view_counts > 0) # if only applying for non-zero DVs
model.nbrm <- glm.nb(view_counts ~ gender + age + education + interest_politics + 
             if_left + if_center + if_right + 
             if_progov + if_neutral + if_antigov, 
           weights = weight,
           control = glm.control(maxit = 5000),
           data = reg_table_filter)
summary(model.nbrm)
```
```{r}
BIC(model.nbrm)
```
```{r}
check_zeroinflation(model.nbrm)
```

```{r}
library(GGally)
ggcoef_model(model.nbrm) + 
  labs(x = "view_counts")
```


There are a few other packages for NB regression
```{r}
library(glmmTMB)
library(brglm2)

model.nbrm2 <- glmmTMB(view_counts ~ gender + age + education + interest_politics + 
             if_left + if_center + if_right + 
             if_progov + if_neutral + if_antigov, 
           weights = weight,
           data = reg_table_filter)
summary(model.nbrm2)
```
```{r}
# very slow
#model.nbrm3 <- brnb(comment_counts ~ gender + age + education + interest_politics + 
#             if_left + if_center + if_right + 
#             if_progov + if_neutral + if_antigov, 
#           weights = weight,
#           data = reg_table_filter)
#summary(model.nbrm3)
```

## Compare Poisson and Negative Binomial

```{r}
logLik(model.prm)
logLik(model.nbrm) # nb is preferred
```

```{r}
AIC(model.prm)
AIC(model.nbrm) # nb is STILL preferred
```

```{r}
check_zeroinflation(model.nbrm)
```

# Now, apply zero-inflated models

```{r}
des = svydesign(
  id = ~0, # specifying cluster ids from largest level to smallest level (0 or 1 is for no clusters)
  weights = ~weight,
  data = reg_table)
```


```{r}
zinb <- zeroinfl(view_counts ~ 
                   gender + age + education + interest_politics + 
                   if_left + if_center + if_right + 
                   if_progov + if_neutral + if_antigov, 
                 data = reg_table, 
                 weights = weight,
                 link = "logit", 
                 dist = "poisson")
summary(zinb)
```
```{r}
AIC(zinb)
```



```{r}
library(GGally)
ggcoef_model(zinb) + 
  labs(x = "view_counts")
```

```{r}
AIC(zinb)
```















